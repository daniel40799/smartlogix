name: SmartLogix CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  backend-test:
    name: Backend Tests (Java 21 + TestContainers)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run backend tests with coverage
        working-directory: backend
        run: mvn verify -B

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: backend/target/surefire-reports/

      - name: Upload JaCoCo coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: backend/target/site/jacoco/

  backend-build:
    name: Backend Docker Build
    runs-on: ubuntu-latest
    needs: backend-test
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: smartlogix-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/backend-image.tar

      - name: Upload backend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: /tmp/backend-image.tar
          retention-days: 1

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          tags: smartlogix-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/frontend-image.tar

      - name: Upload frontend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: /tmp/frontend-image.tar
          retention-days: 1

  docker-compose-validate:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: SMARTLOGIX_JWT_SECRET=ci-validate-only docker compose config

  # ── Security Gate: GitHub CodeQL ─────────────────────────────────────────────
  codeql-analysis:
    name: Security – CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [java, javascript]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21 (for Java analysis)
        if: matrix.language == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Build Java for CodeQL
        if: matrix.language == 'java'
        working-directory: backend
        run: mvn clean compile -B -DskipTests

      - name: Autobuild (JavaScript)
        if: matrix.language == 'javascript'
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: /language:${{ matrix.language }}

  # ── Security Gate: Trivy Container Scanning ──────────────────────────────────
  security-trivy:
    name: Security – Trivy Container Scan
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image
          path: /tmp/

      - name: Load backend Docker image
        run: docker load --input /tmp/backend-image.tar

      - name: Scan backend image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: smartlogix-backend:${{ github.sha }}
          format: sarif
          output: trivy-backend-results.sarif
          severity: CRITICAL,HIGH
          exit-code: '0'
          ignore-unfixed: true

      - name: Upload Trivy backend results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-backend-results.sarif
          category: trivy-backend

      - name: Download frontend image
        uses: actions/download-artifact@v4
        with:
          name: frontend-image
          path: /tmp/

      - name: Load frontend Docker image
        run: docker load --input /tmp/frontend-image.tar

      - name: Scan frontend image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: smartlogix-frontend:${{ github.sha }}
          format: sarif
          output: trivy-frontend-results.sarif
          severity: CRITICAL,HIGH
          exit-code: '0'
          ignore-unfixed: true

      - name: Upload Trivy frontend results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-frontend-results.sarif
          category: trivy-frontend

  # ── Security Gate: OWASP Dependency-Check ────────────────────────────────────
  security-owasp:
    name: Security – OWASP Dependency-Check
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run OWASP Dependency-Check
        working-directory: backend
        env:
          NVD_API_KEY: 9cf42890-587e-4114-bcdd-28b48a58c58b
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressionFile=owasp-suppressions.xml \
            -B

      - name: Upload OWASP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: backend/target/dependency-check-report.html

  # ── Quality Gate: SonarCloud ─────────────────────────────────────────────────
  sonar-quality:
    name: Quality – SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: backend-test
    continue-on-error: true
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Download JaCoCo coverage report
        uses: actions/download-artifact@v4
        with:
          name: jacoco-coverage-report
          path: backend/target/site/jacoco/

      - name: Run SonarCloud analysis
        working-directory: backend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORG: ${{ vars.SONAR_ORG }}
          SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
        run: |
          mvn sonar:sonar -Psonar \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=${SONAR_ORG} \
            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -B

  # ── Performance Gate: k6 Smoke Test ──────────────────────────────────────────
  performance-gate:
    name: Performance – k6 Smoke Test
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image
          path: /tmp/

      - name: Load backend Docker image
        run: |
          docker load --input /tmp/backend-image.tar
          docker tag smartlogix-backend:${{ github.sha }} smartlogix-backend:latest

      - name: Start services with docker-compose
        env:
          SMARTLOGIX_JWT_SECRET: ci-performance-test-secret-key-xxxxxxxxxx
        run: |
          docker compose up -d postgres kafka zookeeper
          sleep 20
          docker compose up -d backend
          echo "Waiting for backend to be healthy..."
          timeout 120 bash -c 'until curl -sf http://localhost:8080/actuator/health; do sleep 5; done'

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring \
            --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" \
            | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Run k6 smoke test
        run: k6 run k6/smoke-test.js
        env:
          BASE_URL: http://localhost:8080

      - name: Stop services
        if: always()
        env:
          SMARTLOGIX_JWT_SECRET: ci-performance-test-secret-key-xxxxxxxxxx
        run: docker compose down -v

  # ── Performance Gate: Lighthouse CI ──────────────────────────────────────────
  lighthouse-ci:
    name: Performance – Lighthouse CI
    runs-on: ubuntu-latest
    needs: frontend-build
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      - name: Install @lhci/cli
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI
        run: lhci autorun --config=.lighthouserc.json
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

